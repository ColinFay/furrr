<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apply Mapping Functions in Parallel using Futures • furrr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><meta property="og:title" content="Apply Mapping Functions in Parallel using Futures">
<meta property="og:description" content="Implementations of the family of map() functions from 'purrr' that can be resolved using any 'future'-supported backend, e.g. parallel on the local machine or distributed on a compute cluster.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">furrr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DavisVaughan/furrr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    

    
    
<!-- README.md is generated from README.Rmd. Please edit that file -->

<div id="furrr" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#furrr" class="anchor"></a>furrr</h1></div>
<p>The goal of furrr is to simplify the combination of <code>purrr</code>’s family of mapping functions and <code>future</code>’s parallel processing capabilities. A new set of <code>future_map_*()</code> functions have been defined, and can be used as (hopefully) drop in replacements for the corresponding <code>map_*()</code> function.</p>
<p>The code draws <em>heavily</em> from the implementations of <code>purrr</code> and <code>future.apply</code> and this package would not be possible without either of them.</p>
<div id="what-has-been-implemented" class="section level2">
<h2 class="hasAnchor">
<a href="#what-has-been-implemented" class="anchor"></a>What has been implemented?</h2>
<p>The full range of <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map()</a></code>, <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map2">map2()</a></code>, <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map2">pmap()</a></code>, <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">walk()</a></code>, <code><a href="http://www.rdocumentation.org/packages/purrr/topics/imap">imap()</a></code>, <code><a href="http://www.rdocumentation.org/packages/purrr/topics/modify">modify()</a></code>, and <code><a href="http://www.rdocumentation.org/packages/purrr/topics/invoke">invoke_map()</a></code> functions have been implemented.</p>
<p>This includes strict versions like <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_dbl()</a></code> through <code><a href="reference/future_map.html">future_map_dbl()</a></code> and predicate versions like <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_at()</a></code> through <code><a href="reference/future_map.html">future_map_at()</a></code>.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the released version of furrr from <a href="https://CRAN.R-project.org">CRAN</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">"furrr"</span>)</a></code></pre></div>
<p>And the development version from <a href="https://github.com/">GitHub</a> with:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># install.packages("devtools")</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"DavisVaughan/furrr"</span>)</a></code></pre></div>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p><code>furrr</code> has been designed to function identically to <code>purrr</code>, so that you can immediately have familiarity with it.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(furrr)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(<span class="kw">c</span>(<span class="st">"hello"</span>, <span class="st">"world"</span>), <span class="op">~</span>.x)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; [1] "hello"</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; [1] "world"</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw"><a href="reference/future_map.html">future_map</a></span>(<span class="kw">c</span>(<span class="st">"hello"</span>, <span class="st">"world"</span>), <span class="op">~</span>.x)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; [1] "hello"</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; [1] "world"</span></a></code></pre></div>
<p>The default backend for <code>future</code> is a sequential one. This means that the code will run out of the box, but it will <em>not</em> be in parallel. The design of <code>future</code> makes this incredibly easy to change so that your code does run in parallel.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># You set a "plan" for how the code should run. The easiest is `multiprocess`</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># On Mac this picks plan(multicore) and on Windows this picks plan(multisession)</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co"># This DOES run in parallel!</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw"><a href="reference/future_map.html">future_map</a></span>(<span class="kw">c</span>(<span class="st">"hello"</span>, <span class="st">"world"</span>), <span class="op">~</span>.x)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; [1] "hello"</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; [1] "world"</span></a></code></pre></div>
<p>If you are still skeptical, here is some proof that we are running in parallel.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(tictoc)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># This should take 6 seconds in total running sequentially</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw">plan</span>(sequential)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">nothingness &lt;-<span class="st"> </span><span class="kw"><a href="reference/future_map.html">future_map</a></span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="op">~</span><span class="kw">Sys.sleep</span>(.x))</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; 6.08 sec elapsed</span></a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># This should take ~2 seconds running in parallel, with a little overhead</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">nothingness &lt;-<span class="st"> </span><span class="kw"><a href="reference/future_map.html">future_map</a></span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="op">~</span><span class="kw">Sys.sleep</span>(.x))</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; 2.212 sec elapsed</span></a></code></pre></div>
</div>
<div id="progress-bars" class="section level2">
<h2 class="hasAnchor">
<a href="#progress-bars" class="anchor"></a>Progress bars</h2>
<p>Who doesn’t love progress bars? For <code>multiprocess</code>, <code>multicore</code>, and <code>multisession</code> plans, you can activate a progress bar for your long running task with <code>.progress = TRUE</code>. Note that these are still a bit experimental so feedback is welcome. You should get a nice progress bar that looks like this:</p>
<p><img src="reference/figures/progress.gif" width="100%"></p>
</div>
<div id="a-more-compelling-use-case" class="section level2">
<h2 class="hasAnchor">
<a href="#a-more-compelling-use-case" class="anchor"></a>A more compelling use case</h2>
<p>This example comes from a Vignette from <code>rsample</code>. The vignette performs a 10 fold cross validation with 10 repeats of a GLM on the attrition data set. If you want all the details with explanation, see <a href="https://topepo.github.io/rsample/articles/Working_with_rsets.html">the vignette</a>.</p>
<p>The vignette example runs pretty quickly on its own, so to make things more…interesting we are going to use 20 fold CV with 100 repeats.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">library</span>(rsample)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">data</span>(<span class="st">"attrition"</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">names</span>(attrition)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt;  [1] "Age"                      "Attrition"               </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt;  [3] "BusinessTravel"           "DailyRate"               </span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt;  [5] "Department"               "DistanceFromHome"        </span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt;  [7] "Education"                "EducationField"          </span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt;  [9] "EnvironmentSatisfaction"  "Gender"                  </span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; [11] "HourlyRate"               "JobInvolvement"          </span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; [13] "JobLevel"                 "JobRole"                 </span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; [15] "JobSatisfaction"          "MaritalStatus"           </span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; [17] "MonthlyIncome"            "MonthlyRate"             </span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; [19] "NumCompaniesWorked"       "OverTime"                </span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt; [21] "PercentSalaryHike"        "PerformanceRating"       </span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt; [23] "RelationshipSatisfaction" "StockOptionLevel"        </span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt; [25] "TotalWorkingYears"        "TrainingTimesLastYear"   </span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt; [27] "WorkLifeBalance"          "YearsAtCompany"          </span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt; [29] "YearsInCurrentRole"       "YearsSinceLastPromotion" </span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt; [31] "YearsWithCurrManager"</span></a></code></pre></div>
<p>Set up an rsample split tibble of 20 fold CV with 100 repeats.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">4622</span>)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">rs_obj &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rsample/topics/vfold_cv">vfold_cv</a></span>(attrition, <span class="dt">v =</span> <span class="dv">20</span>, <span class="dt">repeats =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">rs_obj</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt; #  20-fold cross-validation repeated 100 times </span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt; # A tibble: 2,000 x 3</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt;    splits       id        id2   </span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;    &lt;list&gt;       &lt;chr&gt;     &lt;chr&gt; </span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;  1 &lt;S3: rsplit&gt; Repeat001 Fold01</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt;  2 &lt;S3: rsplit&gt; Repeat001 Fold02</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt;  3 &lt;S3: rsplit&gt; Repeat001 Fold03</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt;  4 &lt;S3: rsplit&gt; Repeat001 Fold04</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt;  5 &lt;S3: rsplit&gt; Repeat001 Fold05</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt;  6 &lt;S3: rsplit&gt; Repeat001 Fold06</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt;  7 &lt;S3: rsplit&gt; Repeat001 Fold07</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt;  8 &lt;S3: rsplit&gt; Repeat001 Fold08</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt;  9 &lt;S3: rsplit&gt; Repeat001 Fold09</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="co">#&gt; 10 &lt;S3: rsplit&gt; Repeat001 Fold10</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="co">#&gt; # ... with 1,990 more rows</span></a></code></pre></div>
<p>The model formula below is going to be used in the GLM.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">mod_form &lt;-<span class="st"> </span><span class="kw">as.formula</span>(Attrition <span class="op">~</span><span class="st"> </span>JobSatisfaction <span class="op">+</span><span class="st"> </span>Gender <span class="op">+</span><span class="st"> </span>MonthlyIncome)</a></code></pre></div>
<p>For each split, we want to calculate assessments on the holdout data, so a function was created to allow us to apply the model and easily extract what we need from each split.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">library</span>(broom)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">## splits will be the `rsplit` object with the 90/10 partition</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">holdout_results &lt;-<span class="st"> </span><span class="cf">function</span>(splits, ...) {</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  <span class="co"># Fit the model to the 90%</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  mod &lt;-<span class="st"> </span><span class="kw">glm</span>(..., <span class="dt">data =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/rsample/topics/as.data.frame.rsplit">analysis</a></span>(splits), <span class="dt">family =</span> binomial)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="co"># Save the 10%</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  holdout &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rsample/topics/as.data.frame.rsplit">assessment</a></span>(splits)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="co"># `augment` will save the predictions with the holdout data set</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  res &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>(mod, <span class="dt">newdata =</span> holdout)</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="co"># Class predictions on the assessment set from class probs</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  lvls &lt;-<span class="st"> </span><span class="kw">levels</span>(holdout<span class="op">$</span>Attrition)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  predictions &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">ifelse</span>(res<span class="op">$</span>.fitted <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, lvls[<span class="dv">2</span>], lvls[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">                        <span class="dt">levels =</span> lvls)</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">  <span class="co"># Calculate whether the prediction was correct</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">  res<span class="op">$</span>correct &lt;-<span class="st"> </span>predictions <span class="op">==</span><span class="st"> </span>holdout<span class="op">$</span>Attrition</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="co"># Return the assessment data set with the additional columns</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">  res</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">}</a></code></pre></div>
<p>Finally, <code>purrr</code> was used to map over all of the splits, apply the model to each, and extract the results.</p>
<p>First in sequential order…</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">library</span>(tictoc)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">rs_obj<span class="op">$</span>results &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(rs_obj<span class="op">$</span>splits, holdout_results, mod_form)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; 30.095 sec elapsed</span></a></code></pre></div>
<p>Then in parallel…</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">library</span>(furrr)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">rs_obj<span class="op">$</span>results &lt;-<span class="st"> </span><span class="kw"><a href="reference/future_map.html">future_map</a></span>(rs_obj<span class="op">$</span>splits, holdout_results, mod_form)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; 14.211 sec elapsed</span></a></code></pre></div>
<p>We don’t get a 4x improvement on my 4 core Mac, but we do get a nice 2x speed up without doing any hard work. The reason we don’t get a 4x improvement is likely because of time spent transfering data to each R process, so this penalty will be minimized with longer running tasks and you might see better performance (for example, 100 fold CV with 100 repeats gave <code>122</code> seconds sequentially and <code>48</code> seconds in parallel). The implementation of <code>future_lapply()</code> does include a scheduling feature, which carried over nicely into <code>furrr</code> and efficiently breaks up the list of splits into 4 equal subsets. Each is passed to 1 core of my machine.</p>
</div>
<div id="a-few-notes-on-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#a-few-notes-on-performance" class="anchor"></a>A few notes on performance</h2>
<div id="data-transfer" class="section level3">
<h3 class="hasAnchor">
<a href="#data-transfer" class="anchor"></a>Data transfer</h3>
<p>It’s important to remember that data has to be passed back and forth between the cores. This means that whatever performance gain you might have gotten from your parallelization can be crushed by moving large amounts of data around. For example, if instead of returning a results data frame in the above example, we returned the larger <code>glm</code> model object for each split, our performance drops a bit.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">model_only &lt;-<span class="st"> </span><span class="cf">function</span>(splits, ...) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="co"># Fit the model to the 90%</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  mod &lt;-<span class="st"> </span><span class="kw">glm</span>(..., <span class="dt">data =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/rsample/topics/as.data.frame.rsplit">analysis</a></span>(splits), <span class="dt">family =</span> binomial)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  mod</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">rs_obj<span class="op">$</span>results2 &lt;-<span class="st"> </span><span class="kw"><a href="reference/future_map.html">future_map</a></span>(rs_obj<span class="op">$</span>splits, model_only, mod_form)</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="kw"><a href="http://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>()</a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; 20.807 sec elapsed</span></a></code></pre></div>
<p>Luckily, the <code>glm</code> model is relatively small, so we don’t experience much loss, but there are model objects out there that can be 10’s of MBs in size. For models like those, I would advise wrapping up the work you want each core to do into a function, and only returning the actual performance metric you are looking for. This might mean a little bit more work on your side, but it results in smaller objects, and faster performance.</p>
<p>This performance drop can especially be prominent if using <code><a href="reference/future_map2.html">future_pmap()</a></code> to iterate over rows and return large objects at each iteration.</p>
</div>
<div id="progress-bars-1" class="section level3">
<h3 class="hasAnchor">
<a href="#progress-bars-1" class="anchor"></a>Progress bars</h3>
<p>Progress bars are best used when iterating over relatively few long running tasks. For instance, they are great when training over hyperparameters of a deep learning model, but I would not suggest them when iterating over the rows of a 100k row data frame. I’ve used every trick that I know to make them have minimal performance impact, but you will see degredation when using them with <em>lots</em> of elements to iterate over.</p>
</div>
</div>
<div id="what-has-not-been-implemented-yet" class="section level2">
<h2 class="hasAnchor">
<a href="#what-has-not-been-implemented-yet" class="anchor"></a>What has not been implemented (yet)?</h2>
<ul>
<li><code><a href="http://www.rdocumentation.org/packages/purrr/topics/lmap">lmap()</a></code></li>
</ul>
</div>
<div id="found-a-bug" class="section level2">
<h2 class="hasAnchor">
<a href="#found-a-bug" class="anchor"></a>Found a bug?</h2>
<p>Feel free to open an issue, and I will do my best to work through it with you!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=furrr">https://​cloud.r-project.org/​package=furrr</a>
</li>
<li>Browse source code at <br><a href="https://github.com/DavisVaughan/furrr">https://​github.com/​DavisVaughan/​furrr</a>
</li>
<li>Report a bug at <br><a href="https://github.com/DavisVaughan/furrr/issues">https://​github.com/​DavisVaughan/​furrr/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>LGPL (&gt;= 2.1)</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Davis Vaughan <br><small class="roles"> Author, maintainer </small>  </li>
<li>Matt Dancho <br><small class="roles"> Author </small>  </li>
</ul>
</div>

      <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/DavisVaughan/furrr"><img src="https://travis-ci.org/DavisVaughan/furrr.svg?branch=master" alt="Travis build status"></a></li>
<li><a href="https://cran.r-project.org/package=furrr"><img src="https://www.r-pkg.org/badges/version/furrr" alt="CRAN status"></a></li>
<li><a href="https://ci.appveyor.com/project/DavisVaughan/furrr"><img src="https://ci.appveyor.com/api/projects/status/github/DavisVaughan/furrr?branch=master&amp;svg=true" alt="AppVeyor build status"></a></li>
</ul>
</div>
</div>

</div>


      <footer><div class="copyright">
  <p>Developed by Davis Vaughan, Matt Dancho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
