<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced furrr: Remote connections • furrr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced furrr: Remote connections">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">furrr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced-furrr-remote-connections.html">Advanced furrr: Remote connections</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DavisVaughan/furrr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Advanced furrr: Remote connections</h1>
                        <h4 class="author">Davis Vaughan</h4>
            
            <h4 class="date">2018-06-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DavisVaughan/furrr/blob/master/vignettes/advanced-furrr-remote-connections.Rmd"><code>vignettes/advanced-furrr-remote-connections.Rmd</code></a></small>
      <div class="hidden name"><code>advanced-furrr-remote-connections.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>At some point, you might need to go beyond your local computer for increased performance and scalability. Luckily, because <code>furrr</code> depends on the powerful underlying <code>future</code> framework, this can be done with relative ease. In this vignette, you will learn how to scale <code>furrr</code> to be used with AWS EC2 in two cases:</p>
<ol style="list-style-type: decimal">
<li>Running code remotely on a single EC2 instance</li>
<li>Additionally running code in parallel on each EC2 instance</li>
</ol>
</div>
<div id="aws-ec2-what" class="section level2">
<h2 class="hasAnchor">
<a href="#aws-ec2-what" class="anchor"></a>AWS EC2? What?</h2>
<p>If you know exactly what AWS EC2 is, and what AMI’s are, feel free to skip this section!</p>
<p><code>AWS EC2 = Amazon Web Services, Elastic Compute Cloud</code></p>
<p>AWS is Amazon’s network of web services they offer to help companies scale to the cloud. This includes hosting databases (RDS), providing domains for websites (Route 53), and, of course, EC2.</p>
<p>EC2 is a way for people like you and me to essentially rent a computer (or multiple) in the cloud for a variable amount of time. The computer can be incredibly powerful, or really weak (and cheap!). It can run Linux, or Windows. With <code>furrr</code>, we will run our code on these EC2 “instances” pre-loaded with R.</p>
<p>How do we get an instance pre-loaded with R? Great question. We will use an AMI. AMI’s are “Amazon Machine Images”, in other words, a custom computer that already has software loaded onto it, rather than one that starts with nothing. A kind soul, Louis Aslett, keeps up-to-date RStudio AMI’s <a href="http://www.louisaslett.com/RStudio_AMI/">on his website</a>. We will use this for our instance.</p>
<p>At this point, I encourage you to look elsewhere for exactly how to set up an AWS instance based on this AMI. I have a blog post dedicated to this, located at my website <a href="https://blog.davisvaughan.com/post/rstudio-shiny-aws-1/">blog.davisvaughan.com</a>.</p>
</div>
<div id="running-code-remotely-on-a-single-ec2-instance" class="section level2">
<h2 class="hasAnchor">
<a href="#running-code-remotely-on-a-single-ec2-instance" class="anchor"></a>Running code remotely on a single EC2 instance</h2>
<p>Imagine you have some models that you want to run, but you don’t want to run them on your local computer. You could test it on your computer, but then you’d ideally like to run them on a more powerful EC2 instance. <em>What if you could change one line of your modeling code to switch between local and EC2?</em> That’s what you’ll learn how to do here.</p>
<div id="modeling-code" class="section level3">
<h3 class="hasAnchor">
<a href="#modeling-code" class="anchor"></a>Modeling code</h3>
<p>First, we need code to run that we want to run in parallel. For simplicity, say we want to run 3 separate linear models on <code>mtcars</code>, split up by <code>gear</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">cars2_mod &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>gear) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(<span class="op">~</span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> .))</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">cars2_mod</a></code></pre></div>
<pre><code>## $`3`
## 
## Call:
## lm(formula = mpg ~ cyl + hp + wt, data = .)
## 
## Coefficients:
## (Intercept)          cyl           hp           wt  
##    30.48956     -0.31883     -0.02326     -2.03083  
## 
## 
## $`4`
## 
## Call:
## lm(formula = mpg ~ cyl + hp + wt, data = .)
## 
## Coefficients:
## (Intercept)          cyl           hp           wt  
##    43.69353      0.05647     -0.12331     -3.20537  
## 
## 
## $`5`
## 
## Call:
## lm(formula = mpg ~ cyl + hp + wt, data = .)
## 
## Coefficients:
## (Intercept)          cyl           hp           wt  
##    45.29099     -2.03268      0.02655     -6.42290</code></pre>
<p>With <code>furrr</code>, we can run this in parallel locally using the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(furrr)</a></code></pre></div>
<pre><code>## Loading required package: future</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">plan</span>(multiprocess)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">cars2_mod_future &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>gear) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/future_map.html">future_map</a></span>(<span class="op">~</span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> .))</a></code></pre></div>
<p><em>Note that this is NOT faster than the sequential code, this is just to demonstrate how one might run the models in parallel.</em></p>
</div>
<div id="connecting-to-an-ec2-instance" class="section level3">
<h3 class="hasAnchor">
<a href="#connecting-to-an-ec2-instance" class="anchor"></a>Connecting to an EC2 instance</h3>
<p>Now, what if these models took hours to run? Maybe we’d want to run them on a different or more powerful computer and then have the results returned right back into your local R session. In that case, go start up your favorite AWS EC2 instance, preloaded with R, and come back when you’ve finished. Then, you’ll need to:</p>
<ul>
<li><p>Get the Public IP of your EC2 instance. This is located under the Instances section of the EC2 console. Specifically it is the IPv4 Public IP of your instance.</p></li>
<li><p>Make sure that your Security Group allows for SSH access either from Anywhere or My IP.</p></li>
<li><p>Find the path to your <code>.pem</code> file that is used to connect to the EC2 instance. This was created when you created the EC2 instance, and hopefully you know where you saved it!</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># A t2.micro AWS instance</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># Created from http://www.louisaslett.com/RStudio_AMI/</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">public_ip &lt;-<span class="st"> "18.206.46.236"</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># This is where my pem file lives (password file to connect).</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">ssh_private_key_file &lt;-<span class="st"> "~/Desktop/programming/AWS/key-pair/dvaughan.pem"</span></a></code></pre></div>
<p>With all of this in hand, the next step is to use <code><a href="http://www.rdocumentation.org/packages/future/topics/makeClusterPSOCK">future::makeClusterPSOCK()</a></code> to connect to the instance. Traditionally, one would use <code><a href="http://www.rdocumentation.org/packages/parallel/topics/makeCluster">parallel::makePSOCKcluster()</a></code> to connect, but the <code>future</code> version has a few additional helpful arguments that allow us to add extra options when connecting to the worker. If the connection is successful, the code below should start outputting package installation messages into your local console.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">cl &lt;-<span class="st"> </span><span class="kw">makeClusterPSOCK</span>(</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="co"># Public IP number of EC2 instance</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="dt">workers =</span> public_ip,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="co"># User name (always 'ubuntu')</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">"ubuntu"</span>,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="co"># Use private SSH key registered with AWS</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  <span class="dt">rshopts =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    <span class="st">"-o"</span>, <span class="st">"StrictHostKeyChecking=no"</span>,</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">    <span class="st">"-o"</span>, <span class="st">"IdentitiesOnly=yes"</span>,</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    <span class="st">"-i"</span>, ssh_private_key_file</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  ),</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  <span class="co"># Set up .libPaths() for the 'ubuntu' user and</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">  <span class="co"># install furrr</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  <span class="dt">rscript_args =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    <span class="st">"-e"</span>, <span class="kw">shQuote</span>(<span class="st">"local({p &lt;- Sys.getenv('R_LIBS_USER'); dir.create(p, recursive = TRUE, showWarnings = FALSE); .libPaths(p)})"</span>),</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">    <span class="st">"-e"</span>, <span class="kw">shQuote</span>(<span class="st">"install.packages('furrr')"</span>)</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">  ),</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb7-23" data-line-number="23">  <span class="co"># Switch this to TRUE to see the code that is run on the workers without</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">  <span class="co"># making the connection</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  <span class="dt">dryrun =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">)</a>
<a class="sourceLine" id="cb7-27" data-line-number="27"></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">cl</a></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">## socket cluster with 1 nodes on host ‘18.206.46.236’</a></code></pre></div>
<p>Let’s step through this a little.</p>
<ul>
<li><p><code>workers</code> - The public ip addresses of the workers you want to connect to. If you have multiple, you can list them here.</p></li>
<li><p><code>user</code> - Because we used the RStudio AMI, this is always <code>"ubuntu"</code>.</p></li>
<li>
<code>rshopts</code> - These are options that are run on the command line of your <em>local</em> computer when connecting to the instance by ssh.
<ul>
<li>
<code>StrictHostKeyChecking=no</code> - This is required because by default when connecting to the AWS instance for the first time you are asked if you want to “continue connecting” because authenticity of the AWS instance can’t be verified. Setting this option to no means we won’t have to answer this question.</li>
<li>
<code>IdentitiesOnly=yes</code> - This is not necessarily required, but specifies that we only want to connect using the identity we supply with <code>-i</code>, which ends up being the <code>.pem</code> file.</li>
</ul>
</li>
<li><p><code>rscript_args</code> - This very helpful argument allows you to specify R code to run when the command line executable <code>Rscript</code> is called on your <em>worker</em>. Essentially, it allows you to run “start up code” on each worker. In this case, it is used to create package paths for the <code>ubuntu</code> user and to install a few packages that are required to work with <code>furrr</code>.</p></li>
<li><p><code>dryrun</code> - This is already set to <code>FALSE</code> by default, but it’s useful to point this argument out as setting it to <code>TRUE</code> allows you to verify that the code that should run on each worker is correct.</p></li>
</ul>
</div>
<div id="running-the-code" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-code" class="anchor"></a>Running the code</h3>
<p>Great! Now we have a connection to our EC2 instance running R. The next step is the one line change I promised earlier. We just need to set our <code>plan()</code> to use the EC2 instance, rather than our local computer. Rather than using the <code>multiprocess</code> plan, we use the <code>cluster</code> plan with the extra argument, <code>workers</code> set to the cluster connection (see <code><a href="http://www.rdocumentation.org/packages/future/topics/cluster">?future::cluster</a></code> for more info).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(furrr)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">plan</span>(cluster, <span class="dt">workers =</span> cl)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">cars2_mod_future &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>gear) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="../reference/future_map.html">future_map</a></span>(<span class="op">~</span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> .))</a></code></pre></div>
<p>And that’s it! Your code just ran on the more powerful EC2 instance!</p>
</div>
</div>
<div id="running-code-in-parallel-on-each-ec2-instance" class="section level2">
<h2 class="hasAnchor">
<a href="#running-code-in-parallel-on-each-ec2-instance" class="anchor"></a>Running code in parallel on each EC2 instance</h2>
<p>Let’s crank it up a notch. Right now, you have 1 EC2 instance, and the code being run on that instance is running sequentially. What if you had multiple EC2 instances, and each of those instances had multiple cores? For maximum efficiency, you’d want to:</p>
<ol style="list-style-type: decimal">
<li>First, parallelize across the EC2 instances.</li>
<li>Then, parallelize across the cores of each EC2 instance.</li>
</ol>
<p>A concrete example might be having 2 t2.xlarge instances, each with 4 cores. This could give you a potential max of ~8x speedup (in reality, it will be more like ~4-6x speed up because 4 of those 8 cores are virtual cores from hyperthreading so you likely won’t get a full linear speed up from them when doing any substantial work).</p>
<p>In the <code>future</code> world, this is dubbed “future topology”, but I also like the term “multi-level parallel processing”.</p>
<div id="connecting-to-multiple-ec2-instances" class="section level3">
<h3 class="hasAnchor">
<a href="#connecting-to-multiple-ec2-instances" class="anchor"></a>Connecting to multiple EC2 instances</h3>
<p>So, just like before, start up your EC2 instance. Except this time, start up multiple of them and make sure to check out the <a href="https://aws.amazon.com/ec2/instance-types/">EC2 instance type</a> reference to see how many vCPUs each one has.</p>
<p>Hint) To launch multiple, after clicking on the AMI you want to use from Louis’s page, under “Configure Instance” change the “Number of instances” box to whatever you require. You might also consider using the Purchasing option, “Request Spot instances” for cheaper instances if you don’t mind the possibility that Amazon could take the instance away from you temporarily at any time.</p>
<p>Note that you now have a vector of public ip addresses.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Two t2.xlarge AWS instances</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># Created from http://www.louisaslett.com/RStudio_AMI/</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">public_ip &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"34.205.203.220"</span>, <span class="st">"52.3.235.148"</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co"># This is where my pem file lives (password file to connect).</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">ssh_private_key_file &lt;-<span class="st"> "~/Desktop/programming/AWS/key-pair/dvaughan.pem"</span></a></code></pre></div>
<p>Otherwise, the code remains the same to make the connection!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">cl_multi &lt;-<span class="st"> </span><span class="kw">makeClusterPSOCK</span>(</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="co"># Public IP number of EC2 instance</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">workers =</span> public_ip,</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  <span class="co"># User name (always 'ubuntu')</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">  <span class="dt">user =</span> <span class="st">"ubuntu"</span>,</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb11-9" data-line-number="9">  <span class="co"># Use private SSH key registered with AWS</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="dt">rshopts =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">    <span class="st">"-o"</span>, <span class="st">"StrictHostKeyChecking=no"</span>,</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">    <span class="st">"-o"</span>, <span class="st">"IdentitiesOnly=yes"</span>,</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">    <span class="st">"-i"</span>, ssh_private_key_file</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">  ),</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb11-16" data-line-number="16">  <span class="co"># Set up .libPaths() for the 'ubuntu' user and</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17">  <span class="co"># install furrr</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">  <span class="dt">rscript_args =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">    <span class="st">"-e"</span>, <span class="kw">shQuote</span>(<span class="st">"local({p &lt;- Sys.getenv('R_LIBS_USER'); dir.create(p, recursive = TRUE, showWarnings = FALSE); .libPaths(p)})"</span>),</a>
<a class="sourceLine" id="cb11-20" data-line-number="20">    <span class="st">"-e"</span>, <span class="kw">shQuote</span>(<span class="st">"install.packages('furrr')"</span>)</a>
<a class="sourceLine" id="cb11-21" data-line-number="21">  ),</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb11-23" data-line-number="23">  <span class="co"># Switch this to TRUE to see the code that is run on the workers without</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24">  <span class="co"># making the connection</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25">  <span class="dt">dryrun =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26">)</a>
<a class="sourceLine" id="cb11-27" data-line-number="27"></a>
<a class="sourceLine" id="cb11-28" data-line-number="28">cl_multi</a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">## socket cluster with 2 nodes on hosts ‘34.205.203.220’, ‘52.3.235.148’</a></code></pre></div>
</div>
<div id="running-multi-level-parallel-code" class="section level3">
<h3 class="hasAnchor">
<a href="#running-multi-level-parallel-code" class="anchor"></a>Running multi-level parallel code</h3>
<p>Now for the fun part. How do we tell <code>future</code> to first distribute our code over the 2 instances, and then run in parallel on each instance? You pass in a list of plans to <code>plan()</code>, where you also have the option to <code>tweak()</code> each plan individually (which will be required to set the workers argument!).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">library</span>(furrr)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co"># The outer plan tells future to distribute over the 2 instances</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co"># The inner plan says to run in parallel on each instance</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw">plan</span>(<span class="kw">list</span>(<span class="kw">tweak</span>(cluster, <span class="dt">workers =</span> cl_multi), multiprocess))</a></code></pre></div>
<p>How do we know this is working? Let’s try doing something that would require a fixed amount of time when run locally, then try it in parallel. We are just going to wait for 5 seconds on each iteration, and then return the instance we are on and the core we are using. In total this should take <code>40 seconds</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">plan</span>(sequential)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/future_map.html">future_map</a></span>(</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb14-7" data-line-number="7">  <span class="co"># Map over the two instances</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  <span class="dt">.x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">    </a>
<a class="sourceLine" id="cb14-12" data-line-number="12">    outer_idx &lt;-<span class="st"> </span>.x</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb14-14" data-line-number="14">    <span class="kw"><a href="../reference/future_map.html">future_map</a></span>(</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">      </a>
<a class="sourceLine" id="cb14-16" data-line-number="16">      <span class="co"># Each instance has 4 cores we can utilize</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17">      <span class="dt">.x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </a>
<a class="sourceLine" id="cb14-18" data-line-number="18">      </a>
<a class="sourceLine" id="cb14-19" data-line-number="19">      <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb14-20" data-line-number="20">        inner_idx &lt;-<span class="st"> </span>.x</a>
<a class="sourceLine" id="cb14-21" data-line-number="21">        <span class="kw">Sys.sleep</span>(<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb14-22" data-line-number="22">        <span class="kw">paste0</span>(<span class="st">"Instance: "</span>, outer_idx, <span class="st">" and core: "</span>, inner_idx)</a>
<a class="sourceLine" id="cb14-23" data-line-number="23">      }</a>
<a class="sourceLine" id="cb14-24" data-line-number="24">    )</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">    </a>
<a class="sourceLine" id="cb14-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">)</a>
<a class="sourceLine" id="cb14-28" data-line-number="28"></a>
<a class="sourceLine" id="cb14-29" data-line-number="29">t2 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb14-30" data-line-number="30"></a>
<a class="sourceLine" id="cb14-31" data-line-number="31">res</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">## [[1]]</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">## [[1]][[1]]</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">## [1] "Instance: 1 and core: 1"</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">## </a>
<a class="sourceLine" id="cb15-5" data-line-number="5">## [[1]][[2]]</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">## [1] "Instance: 1 and core: 2"</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">## </a>
<a class="sourceLine" id="cb15-8" data-line-number="8">## [[1]][[3]]</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">## [1] "Instance: 1 and core: 3"</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">## </a>
<a class="sourceLine" id="cb15-11" data-line-number="11">## [[1]][[4]]</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">## [1] "Instance: 1 and core: 4"</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">## </a>
<a class="sourceLine" id="cb15-14" data-line-number="14">## </a>
<a class="sourceLine" id="cb15-15" data-line-number="15">## [[2]]</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">## [[2]][[1]]</a>
<a class="sourceLine" id="cb15-17" data-line-number="17">## [1] "Instance: 2 and core: 1"</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">## </a>
<a class="sourceLine" id="cb15-19" data-line-number="19">## [[2]][[2]]</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">## [1] "Instance: 2 and core: 2"</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">## </a>
<a class="sourceLine" id="cb15-22" data-line-number="22">## [[2]][[3]]</a>
<a class="sourceLine" id="cb15-23" data-line-number="23">## [1] "Instance: 2 and core: 3"</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">## </a>
<a class="sourceLine" id="cb15-25" data-line-number="25">## [[2]][[4]]</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">## [1] "Instance: 2 and core: 4"</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">t2 <span class="op">-</span><span class="st"> </span>t1</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">##   user  system elapsed </a>
<a class="sourceLine" id="cb17-2" data-line-number="2">##  0.227   0.122  40.146 </a></code></pre></div>
<p>Now, in parallel with our cluster. The outer <code><a href="../reference/future_map.html">future_map()</a></code> call distributes over the two instances, and the inner <code><a href="../reference/future_map.html">future_map()</a></code> call distributes over the cores of each instance. This should take <code>~5 seconds</code>, with some overhead.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">plan</span>(<span class="kw">list</span>(<span class="kw">tweak</span>(cluster, <span class="dt">workers =</span> cl_multi), multiprocess))</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">t1 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/future_map.html">future_map</a></span>(</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb18-7" data-line-number="7">  <span class="co"># Map over the two instances</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">  <span class="dt">.x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), </a>
<a class="sourceLine" id="cb18-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb18-10" data-line-number="10">  <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">    </a>
<a class="sourceLine" id="cb18-12" data-line-number="12">    outer_idx &lt;-<span class="st"> </span>.x</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb18-14" data-line-number="14">    <span class="kw"><a href="../reference/future_map.html">future_map</a></span>(</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">      </a>
<a class="sourceLine" id="cb18-16" data-line-number="16">      <span class="co"># Each instance has 4 cores we can utilize</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">      <span class="dt">.x =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </a>
<a class="sourceLine" id="cb18-18" data-line-number="18">      </a>
<a class="sourceLine" id="cb18-19" data-line-number="19">      <span class="dt">.f =</span> <span class="op">~</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">        inner_idx &lt;-<span class="st"> </span>.x</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">        <span class="kw">Sys.sleep</span>(<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">        <span class="kw">paste0</span>(<span class="st">"Instance: "</span>, outer_idx, <span class="st">" and core: "</span>, inner_idx)</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">      }</a>
<a class="sourceLine" id="cb18-24" data-line-number="24">    )</a>
<a class="sourceLine" id="cb18-25" data-line-number="25">    </a>
<a class="sourceLine" id="cb18-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">)</a>
<a class="sourceLine" id="cb18-28" data-line-number="28"></a>
<a class="sourceLine" id="cb18-29" data-line-number="29">t2 &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">t2 <span class="op">-</span><span class="st"> </span>t1</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">##   user  system elapsed </a>
<a class="sourceLine" id="cb20-2" data-line-number="2">##  0.126   0.029   8.099 </a></code></pre></div>
<p>Not bad! The extra few seconds are due to the overhead of communicating with the AWS workers, but with a large model this would not be relevant.</p>
</div>
<div id="conclusion" class="section level3">
<h3 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h3>
<p>In this vignette, you learned how to distribute your code over AWS EC2 instances, and run code in parallel on each instance using <code>future</code> and <code>furrr</code>. Note that the code used here can also be used to run code on platforms such as Google Cloud Compute, or other remote clusters. You will just have to figure out the correct way to connect to those clusters. Additionally, once you have the connection in place you could just run basic <code>future()</code> commands to distribute code as well. This has the added benefit of not locking up your computer until you request the result with <code>value()</code>. Happy parallelizing!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#aws-ec2-what">AWS EC2? What?</a></li>
      <li><a href="#running-code-remotely-on-a-single-ec2-instance">Running code remotely on a single EC2 instance</a></li>
      <li><a href="#running-code-in-parallel-on-each-ec2-instance">Running code in parallel on each EC2 instance</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Davis Vaughan, Matt Dancho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
